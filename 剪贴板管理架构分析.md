# 剪贴板管理功能架构分析

## 整体架构 ASCII 图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         剪贴板管理系统架构                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            数据存储层 (Data Layer)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────┐    ┌──────────────────────────────┐      │
│  │  ClipboardHistory_CtrlC[]    │    │ ClipboardHistory_CapsLockC[] │      │
│  │  (Ctrl+C 历史记录)            │    │ (CapsLock+C 历史记录)        │      │
│  ├──────────────────────────────┤    ├──────────────────────────────┤      │
│  │  • 最大容量: 100条            │    │  • 最大容量: 100条            │      │
│  │  • 数据类型: 字符串数组        │    │  • 数据类型: 字符串数组        │      │
│  │  • 自动去重: 是                │    │  • 自动去重: 是                │      │
│  │  • 触发方式: OnClipboardChange│    │  • 触发方式: CapsLock+C       │      │
│  └──────────────────────────────┘    └──────────────────────────────┘      │
│           ▲                                      ▲                          │
│           │                                      │                          │
│           └──────────────┬───────────────────────┘                          │
│                          │                                                  │
└──────────────────────────┼──────────────────────────────────────────────────┘
                           │
                           │ 数据读写
                           │
┌──────────────────────────┼──────────────────────────────────────────────────┐
│                          │    业务逻辑层 (Business Logic Layer)              │
├──────────────────────────┼──────────────────────────────────────────────────┤
│                          │                                                  │
│  ┌───────────────────────▼──────────────────────────────────────────────┐  │
│  │                      数据采集模块                                      │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  ┌────────────────────────┐        ┌──────────────────────────┐      │  │
│  │  │  OnClipboardChange()   │        │    CapsLockCopy()        │      │  │
│  │  │  (监听系统剪贴板变化)   │        │  (主动复制到管理列表)     │      │  │
│  │  ├────────────────────────┤        ├──────────────────────────┤      │  │
│  │  │  • 监听 Ctrl+C          │        │  • 执行 Ctrl+C 复制       │      │  │
│  │  │  • 自动去重检查          │        │  • 保存到 CapsLockC 数组  │      │  │
│  │  │  • 保存到 CtrlC 数组     │        │  • 不改变系统剪贴板       │      │  │
│  │  │  • 延迟刷新面板 (100ms)  │        │  • 显示成功提示           │      │  │
│  │  │  • 防重复记录机制        │        │  • 延迟刷新面板 (100ms)   │      │  │
│  │  └────────────────────────┘        └──────────────────────────┘      │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                          │                                                  │
│  ┌───────────────────────▼──────────────────────────────────────────────┐  │
│  │                      数据管理模块                                      │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  RefreshClipboardList()      - 刷新列表显示                            │  │
│  │    ├─ 根据当前Tab选择数据源                                            │  │
│  │    ├─ 生成预览文本 (80字符)                                            │  │
│  │    ├─ 清空并重新填充ListBox                                            │  │
│  │    └─ 更新统计信息                                                     │  │
│  │                                                                        │  │
│  │  SwitchClipboardTab(TabName) - 切换Tab                                 │  │
│  │    ├─ 更新 Tab 样式 (激活/非激活)                                      │  │
│  │    ├─ 清空列表内容                                                     │  │
│  │    ├─ 调用 RefreshClipboardList()                                     │  │
│  │    └─ 防止标签点击触发复制 (CapsLock保护机制)                          │  │
│  │                                                                        │  │
│  │  ClearAllClipboard()         - 清空当前Tab的所有记录                   │  │
│  │                                                                        │  │
│  │  CopySelectedItem()          - 复制选中项到系统剪贴板                  │  │
│  │                                                                        │  │
│  │  DeleteSelectedItem()        - 删除选中项                              │  │
│  │                                                                        │  │
│  │  PasteSelectedToCursor()     - 粘贴选中项到Cursor                      │  │
│  │                                                                        │  │
│  │  CapsLockPaste()             - 合并粘贴所有CapsLock+C内容              │  │
│  │    ├─ 合并所有内容 (用双换行分隔)                                       │  │
│  │    ├─ 激活Cursor窗口                                                   │  │
│  │    ├─ 打开AI聊天面板 (Ctrl+L)                                          │  │
│  │    ├─ 粘贴合并内容                                                     │  │
│  │    └─ 清空历史记录                                                     │  │
│  │                                                                        │  │
│  │  ExportClipboard()           - 导出剪贴板数据到文件                    │  │
│  │                                                                        │  │
│  │  ImportClipboard()           - 从文件导入剪贴板数据                    │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                          │                                                  │
└──────────────────────────┼──────────────────────────────────────────────────┘
                           │
                           │ 事件/函数调用
                           │
┌──────────────────────────┼──────────────────────────────────────────────────┐
│                          │    表示层 (Presentation Layer / UI)              │
├──────────────────────────┼──────────────────────────────────────────────────┤
│                          │                                                  │
│  ┌───────────────────────▼──────────────────────────────────────────────┐  │
│  │                    ShowClipboardManager()                             │  │
│  │                    (创建和管理面板)                                    │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────┐    │  │
│  │  │                    标题栏区域 (Y: 0-40)                        │    │  │
│  │  ├──────────────────────────────────────────────────────────────┤    │  │
│  │  │  [标题文字: 📋 剪贴板管理]    [关闭按钮: ✕]                    │    │  │
│  │  │  • 可拖动窗口                                                  │    │  │
│  │  │  • 始终置顶                                                    │    │  │
│  │  └──────────────────────────────────────────────────────────────┘    │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────┐    │  │
│  │  │                 工具栏区域 (Y: 41-86)                          │    │  │
│  │  ├──────────────────────────────────────────────────────────────┤    │  │
│  │  │  [Ctrl+C Tab]  [CapsLock+C Tab]  [清空全部]  [统计: 共X项]    │    │  │
│  │  │  • Tab切换: SwitchClipboardTab()                               │    │  │
│  │  │  • 清空按钮: ClearAllClipboard()                               │    │  │
│  │  │  • 统计信息: 实时显示当前Tab的记录数                            │    │  │
│  │  └──────────────────────────────────────────────────────────────┘    │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────┐    │  │
│  │  │                  列表区域 (Y: 100-420)                         │    │  │
│  │  ├──────────────────────────────────────────────────────────────┤    │  │
│  │  │  ListBox控件 (560×320)                                        │    │  │
│  │  │  ┌────────────────────────────────────────────────────────┐  │    │  │
│  │  │  │ [1] 预览文本内容 (最多80字符)...                       │  │    │  │
│  │  │  │ [2] 预览文本内容 (最多80字符)...                       │  │    │  │
│  │  │  │ [3] 预览文本内容 (最多80字符)...                       │  │    │  │
│  │  │  │ ...                                                    │  │    │  │
│  │  │  └────────────────────────────────────────────────────────┘  │    │  │
│  │  │  • 显示格式: [序号] 预览文本...                               │    │  │
│  │  │  • 双击事件: CopySelectedItem()                              │    │  │
│  │  │  • 选中变化: OnClipboardListBoxChange()                      │    │  │
│  │  └──────────────────────────────────────────────────────────────┘    │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────┐    │  │
│  │  │                 底部按钮区域 (Y: 430-500)                      │    │  │
│  │  ├──────────────────────────────────────────────────────────────┤    │  │
│  │  │  [复制选中] [删除选中] [粘贴到Cursor] [导出] [导入]           │    │  │
│  │  │                                                               │    │  │
│  │  │  功能按钮:                                                    │    │  │
│  │  │  • 复制选中: CopySelectedItem()                              │    │  │
│  │  │  • 删除选中: DeleteSelectedItem()                            │    │  │
│  │  │  • 粘贴到Cursor: PasteSelectedToCursor() (主要按钮)          │    │  │
│  │  │  • 导出剪贴板: ExportClipboard()                             │    │  │
│  │  │  • 导入剪贴板: ImportClipboard()                             │    │  │
│  │  │                                                               │    │  │
│  │  │  底部提示: "双击项目可复制 | ESC 关闭"                        │    │  │
│  │  └──────────────────────────────────────────────────────────────┘    │  │
│  │                                                                        │  │
│  │  窗口属性:                                                             │  │
│  │  • 尺寸: 600×500                                                      │  │
│  │  • 无边框: -Caption                                                   │  │
│  │  • 始终置顶: +AlwaysOnTop                                            │  │
│  │  • 多屏幕支持: GetScreenInfo() + GetPanelPosition()                  │  │
│  │  • ESC关闭: CloseClipboardManager()                                  │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                          │                                                  │
└──────────────────────────┼──────────────────────────────────────────────────┘
                           │
                           │ 快捷键触发
                           │
┌──────────────────────────┼──────────────────────────────────────────────────┐
│                          │    入口层 (Entry Layer)                          │
├──────────────────────────┼──────────────────────────────────────────────────┤
│                          │                                                  │
│  ┌───────────────────────▼──────────────────────────────────────────────┐  │
│  │                        快捷键入口                                      │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  CapsLock + X  ──────→  ShowClipboardManager()                       │  │
│  │  (打开剪贴板管理面板)                                                  │  │
│  │                                                                        │  │
│  │  CapsLock + C  ──────→  CapsLockCopy()                               │  │
│  │  (连续复制到管理列表)                                                  │  │
│  │                                                                        │  │
│  │  CapsLock + V  ──────→  CapsLockPaste()                              │  │
│  │  (合并粘贴所有内容到Cursor)                                            │  │
│  │                                                                        │  │
│  │  Ctrl + C     ──────→  OnClipboardChange()                           │  │
│  │  (系统剪贴板变化，自动记录)                                            │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                          │                                                  │
└──────────────────────────────────────────────────────────────────────────────┘
```

## 核心数据流

```
用户操作流程:

1. 复制操作流程:
   ┌─────────────┐
   │ 用户复制操作 │
   └──────┬──────┘
          │
          ├─→ Ctrl+C ──────→ OnClipboardChange() ──→ ClipboardHistory_CtrlC[]
          │                                                      │
          │                                                      └─→ 延迟刷新面板 (100ms)
          │                                                              │
          │                                                              ▼
          └─→ CapsLock+C ─→ CapsLockCopy() ──→ ClipboardHistory_CapsLockC[]
                                                          │
                                                          └─→ 延迟刷新面板 (100ms)
                                                                  │
                                                                  ▼
                                                            RefreshClipboardList()
                                                                  │
                                                                  ▼
                                                            ListBox更新显示


2. 粘贴操作流程:
   ┌─────────────┐
   │ 用户选择项   │
   └──────┬──────┘
          │
          ├─→ 双击/点击"复制选中" ─→ CopySelectedItem() ──→ 系统剪贴板
          │                                                          │
          │                                                          └─→ 用户可粘贴
          │
          ├─→ 点击"粘贴到Cursor" ─→ PasteSelectedToCursor()
          │                                       │
          │                                       ├─→ 激活Cursor窗口
          │                                       ├─→ 打开AI聊天面板
          │                                       ├─→ 复制内容到剪贴板
          │                                       └─→ 发送Ctrl+V粘贴
          │
          └─→ CapsLock+V ─→ CapsLockPaste()
                              │
                              ├─→ 合并所有CapsLock+C内容
                              ├─→ 激活Cursor窗口
                              ├─→ 打开AI聊天面板
                              ├─→ 粘贴合并内容
                              └─→ 清空历史记录


3. 管理操作流程:
   ┌─────────────┐
   │ 用户管理操作 │
   └──────┬──────┘
          │
          ├─→ 切换Tab ─→ SwitchClipboardTab()
          │                  │
          │                  ├─→ 更新Tab样式
          │                  ├─→ 清空列表
          │                  └─→ RefreshClipboardList()
          │
          ├─→ 删除项 ─→ DeleteSelectedItem()
          │               │
          │               ├─→ 从数组删除
          │               └─→ RefreshClipboardList()
          │
          └─→ 清空全部 ─→ ClearAllClipboard()
                            │
                            ├─→ 确认对话框
                            ├─→ 清空当前Tab数组
                            └─→ RefreshClipboardList()
```

## 关键设计模式

### 1. 双数据源隔离模式
- **Ctrl+C** 和 **CapsLock+C** 使用完全独立的数据存储
- 两个Tab分别显示各自的数据源
- 互不干扰，独立管理

### 2. 延迟刷新机制
- 使用 `SetTimer(RefreshClipboardListDelayed, -100)` 延迟刷新
- 避免频繁刷新造成的性能问题
- 确保数据已完全更新后再刷新UI

### 3. Tab切换保护机制
- 点击CapsLock+C Tab时，设置保护标记防止触发复制
- 使用 `CapsLockCopyInProgress` 和 `CapsLockCopyEndTime` 防止误触发
- 延迟恢复CapsLock状态，确保标签切换正常

### 4. 预览文本生成
- 显示时只显示前80个字符作为预览
- 处理换行、制表符等特殊字符
- 保持原始数据的完整性

### 5. 选中状态恢复
- 使用 `LastSelectedIndex` 保存最后选中的索引
- 刷新列表后尝试恢复选中状态
- 提供更好的用户体验

## 全局变量管理

```
核心全局变量:
├─ ClipboardHistory_CtrlC[]      - Ctrl+C历史记录数组
├─ ClipboardHistory_CapsLockC[]  - CapsLock+C历史记录数组
├─ ClipboardCurrentTab            - 当前激活的Tab ("CtrlC" | "CapsLockC")
├─ GuiID_ClipboardManager         - 面板GUI对象引用
├─ ClipboardListBox               - ListBox控件引用
├─ ClipboardCountText             - 统计文本控件引用
├─ ClipboardCtrlCTab              - CtrlC Tab控件引用
├─ ClipboardCapsLockCTab          - CapsLockC Tab控件引用
└─ LastSelectedIndex              - 最后选中的索引（用于恢复）
```

## 关键函数说明

| 函数名 | 功能 | 调用时机 |
|--------|------|----------|
| `ShowClipboardManager()` | 创建并显示剪贴板管理面板 | CapsLock+X |
| `RefreshClipboardList()` | 刷新列表显示 | 数据变化、Tab切换后 |
| `SwitchClipboardTab()` | 切换Tab并刷新列表 | 点击Tab时 |
| `CapsLockCopy()` | 复制到CapsLock+C历史 | CapsLock+C |
| `OnClipboardChange()` | 监听Ctrl+C并记录 | 系统剪贴板变化 |
| `CapsLockPaste()` | 合并粘贴所有内容 | CapsLock+V |
| `CopySelectedItem()` | 复制选中项 | 双击/点击按钮 |
| `DeleteSelectedItem()` | 删除选中项 | 点击删除按钮 |
| `ClearAllClipboard()` | 清空当前Tab所有记录 | 点击清空按钮 |

## UI布局坐标说明

```
窗口尺寸: 600 × 500

Y坐标布局:
├─ 0-40:     标题栏区域
├─ 40:       分隔线 (1px)
├─ 41-86:    工具栏区域 (Tab + 按钮 + 统计)
├─ 100-420:  列表区域 (ListBox, 320px高)
├─ 430-500:  底部按钮区域 + 提示文字
└─ 485-500:  底部提示文字

X坐标布局:
├─ 0-560:    标题栏可拖动区域
├─ 560-600:  关闭按钮
├─ 20:       左边界距
├─ 430-580:  统计信息区域
└─ 20-580:   内容区域 (边距20px)
```

